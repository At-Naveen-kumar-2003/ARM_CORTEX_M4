#include "stm32f4xx.h"

void PWM_Init(uint32_t pwm_freq_hz, uint32_t sysclk_hz)
{
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN | RCC_AHB1ENR_GPIOBEN;
    RCC->APB2ENR |= RCC_APB2ENR_TIM1EN;

    GPIOA->MODER &= ~(3U << (8 * 2));
    GPIOA->MODER |=  (2U << (8 * 2));
    GPIOA->OTYPER &= ~(1U << 8);
    GPIOA->OSPEEDR |= (3U << (8 * 2));
    GPIOA->AFR[1] &= ~(0xFU << 0);
    GPIOA->AFR[1] |=  (1U << 0);

    GPIOB->MODER &= ~(3U << (13 * 2));
    GPIOB->MODER |=  (2U << (13 * 2));
    GPIOB->OTYPER &= ~(1U << 13);
    GPIOB->OSPEEDR |= (3U << (13 * 2));
    GPIOB->AFR[1] &= ~(0xFU << ((13 - 8) * 4));
    GPIOB->AFR[1] |=  (1U << ((13 - 8) * 4));

    uint32_t prescaler = (sysclk_hz / 1000000) - 1;
    uint32_t period = (1000000 / pwm_freq_hz) - 1;

    TIM1->PSC  = prescaler;
    TIM1->ARR  = period;
    TIM1->CCR1 = period / 2;

    TIM1->CCMR1 &= ~(7U << 4);
    TIM1->CCMR1 |=  (6U << 4);
    TIM1->CCMR1 |= TIM_CCMR1_OC1PE;

    TIM1->CCER = 0;
    TIM1->CCER |= TIM_CCER_CC1E | TIM_CCER_CC1NE;

    TIM1->BDTR = 0;
    TIM1->BDTR |= 84;
    TIM1->BDTR |= TIM_BDTR_MOE;

    TIM1->CR1 |= TIM_CR1_ARPE;
    TIM1->CR1 |= TIM_CR1_CEN;
}

void PWM_SetDutyCycle(uint8_t duty_cycle)
{
    if (duty_cycle > 100) duty_cycle = 100;
    TIM1->CCR1 = ((TIM1->ARR + 1) * duty_cycle) / 100;
}

int main(void)
{
    PWM_Init(1000, 84000000);
    PWM_SetDutyCycle(80);

    while (1);
}
